{% extends './base.html' %}
{% block title %} Detalle del Torneo {% endblock %}

{% block body %}
<div class="container mt-4" style="background-color: #f8841c; padding: 20px; border-radius: 10px;">
  <h2 class="text-center mb-4" style="color: black; font-weight: bold;">
    {{ equipo.nombre }} &mdash; {{ torneo.nombre_torneo }}
  </h2>
  <div class="mb-3 text-center">
    <a href="{{ url_for('torneo.detalle_torneo', nombre_equipo=equipo.nombre|replace(' ', '-'), id_torneo=id_torneo, nombre_torneo=torneo.nombre_torneo|replace(' ', '-')) }}" class="btn btn-secondary">
      Volver a los detalles del torneo
    </a>
  </div>

  <div class="d-flex justify-content-between mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearPartidoModal">Nuevo Partido</button>
    <button class="btn btn-danger" id="borrarPartidosSeleccionados">Borrar seleccionados</button>
  </div>

  <form id="partidosForm">
    <table class="table text-center" style="border-radius: 10px; overflow: hidden;">
      <thead style="background-color: black; color: white;">
        <tr>
          <th><input type="checkbox" id="selectAllPartidos"></th>
          <th>Nombre Partido</th>
          <th>Equipo Rival</th>
          <th>Fecha</th>
          <th>Lugar</th>
          <th>Marcador Local</th>
          <th>Marcador Rival</th>
          <th>Video</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for partido in partidos %}
        <tr style="background-color: white; color: black;">
          <td><input type="checkbox" name="partidosSeleccionados" value="{{ partido.nombre_partido }}"></td>
          <td>{{ partido.nombre_partido }}</td>
          <td>{{ partido.nombre_equipo_rival }}</td>
          <td>{{ partido.fecha }}</td>
          <td>{{ partido.lugar or '---' }}</td>
          <td>{{ partido.marcador_local }}</td>
          <td>{{ partido.marcador_rival }}</td>
          <td>
            {% if partido.video_url %}
              <a href="{{ partido.video_url }}" target="_blank">Ver Video</a>
            {% else %}
              ---
            {% endif %}
          </td>
          <td>{{ partido.observaciones or '---' }}</td>
          <td>
            <button type="button" class="btn btn-warning btn-sm editarPartido" data-nombre="{{ partido.nombre_partido }}">Editar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <div class="text-center">
    <a href="{{ url_for('torneo.detalle_torneo', id_torneo=id_torneo, nombre_equipo=equipo.nombre, nombre_torneo=torneo.nombre) }}" class="btn btn-secondary mt-4">Volver</a>
  </div>
</div>

<!-- Modal para crear partido -->
<div class="modal fade" id="crearPartidoModal" tabindex="-1" aria-labelledby="crearPartidoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="crearPartidoModalLabel">Crear Nuevo Partido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="crearPartidoForm">
          <input type="hidden" name="id_torneo" value="{{ torneo.id_torneo }}">
          <div class="mb-3">
            <label for="nombre_partido" class="form-label">Nombre Partido</label>
            <input type="text" class="form-control" id="nombre_partido" name="nombre_partido" required>
          </div>
          <div class="mb-3">
            <label for="nombre_equipo_rival" class="form-label">Equipo Rival</label>
            <input type="text" class="form-control" id="nombre_equipo_rival" name="nombre_equipo_rival" required>
          </div>
          <div class="mb-3">
            <label for="fecha" class="form-label">Fecha y Hora</label>
            <input type="datetime-local" class="form-control" id="fecha" name="fecha" required>
          </div>
          <div class="mb-3">
            <label for="lugar" class="form-label">Lugar</label>
            <input type="text" class="form-control" id="lugar" name="lugar">
          </div>
          <div class="mb-3">
            <label for="marcador_local" class="form-label">Marcador Local</label>
            <input type="number" class="form-control" id="marcador_local" name="marcador_local" required min="0">
          </div>
          <div class="mb-3">
            <label for="marcador_rival" class="form-label">Marcador Rival</label>
            <input type="number" class="form-control" id="marcador_rival" name="marcador_rival" required min="0">
          </div>
          <div class="mb-3">
            <label for="video_url" class="form-label">URL Video</label>
            <input type="url" class="form-control" id="video_url" name="video_url">
          </div>
          <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="observaciones" name="observaciones"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Crear</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar partido -->
<div class="modal fade" id="editarPartidoModal" tabindex="-1" aria-labelledby="editarPartidoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarPartidoModalLabel">Editar Partido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editarPartidoForm">
          <input type="hidden" id="editar_original_nombre" name="original_nombre">
          <input type="hidden" name="id_torneo" value="{{ torneo.id_torneo }}">
          <div class="mb-3">
            <label for="editar_nombre_partido" class="form-label">Nombre Partido</label>
            <input type="text" class="form-control" id="editar_nombre_partido" name="nombre_partido" required>
          </div>
          <div class="mb-3">
            <label for="editar_nombre_equipo_rival" class="form-label">Equipo Rival</label>
            <input type="text" class="form-control" id="editar_nombre_equipo_rival" name="nombre_equipo_rival" required>
          </div>
          <div class="mb-3">
            <label for="editar_fecha" class="form-label">Fecha y Hora</label>
            <input type="datetime-local" class="form-control" id="editar_fecha" name="fecha" required>
          </div>
          <div class="mb-3">
            <label for="editar_lugar" class="form-label">Lugar</label>
            <input type="text" class="form-control" id="editar_lugar" name="lugar">
          </div>
          <div class="mb-3">
            <label for="editar_marcador_local" class="form-label">Marcador Local</label>
            <input type="number" class="form-control" id="editar_marcador_local" name="marcador_local" required min="0">
          </div>
          <div class="mb-3">
            <label for="editar_marcador_rival" class="form-label">Marcador Rival</label>
            <input type="number" class="form-control" id="editar_marcador_rival" name="marcador_rival" required min="0">
          </div>
          <div class="mb-3">
            <label for="editar_video_url" class="form-label">URL Video</label>
            <input type="url" class="form-control" id="editar_video_url" name="video_url">
          </div>
          <div class="mb-3">
            <label for="editar_observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="editar_observaciones" name="observaciones"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Función genérica de fetch
  function sendFetch(url, method, data) {
    const opts = { method: method, headers: { 'Content-Type': 'application/json' } };
    if (data) opts.body = JSON.stringify(data);
    return fetch(url, opts)
      .then(res => { if (!res.ok) throw new Error(); return res.json(); });
  }

  // Seleccionar todos los partidos
  document.getElementById('selectAllPartidos').addEventListener('change', function() {
    document.querySelectorAll("input[name='partidosSeleccionados']").forEach(cb => cb.checked = this.checked);
  });

  // Crear partido
  document.getElementById('crearPartidoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    sendFetch('/partido/', 'POST', data)
      .then(() => location.reload())
      .catch(console.error);
  });

  // Editar partido: abrir modal con datos
  document.querySelectorAll('.editarPartido').forEach(btn => {
    btn.addEventListener('click', function() {
      const nombre = this.dataset.nombre;
      const row = this.closest('tr');
      document.getElementById('editar_original_nombre').value = nombre;
      document.getElementById('editar_nombre_partido').value = row.children[1].innerText.trim();
      document.getElementById('editar_nombre_equipo_rival').value = row.children[2].innerText.trim();
      document.getElementById('editar_fecha').value = row.children[3].innerText.replace(' ', 'T');
      document.getElementById('editar_lugar').value = row.children[4].innerText.trim();
      document.getElementById('editar_marcador_local').value = row.children[5].innerText;
      document.getElementById('editar_marcador_rival').value = row.children[6].innerText;
      document.getElementById('editar_video_url').value = row.children[7].querySelector('a')?.href || '';
      document.getElementById('editar_observaciones').value = row.children[8].innerText.trim();
      new bootstrap.Modal(document.getElementById('editarPartidoModal')).show();
    });
  });

  // Guardar edición
  document.getElementById('editarPartidoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    const original = data.original_nombre;
    sendFetch(`/partido/${original}`, 'PUT', data)
      .then(() => location.reload())
      .catch(console.error);
  });

  // Borrar partidos seleccionados
  document.getElementById('borrarPartidosSeleccionados').addEventListener('click', function() {
    const seleccionados = Array.from(document.querySelectorAll("input[name='partidosSeleccionados']:checked")).map(cb => cb.value);
    if (!seleccionados.length) return alert('No hay partidos seleccionados');
    Promise.all(seleccionados.map(nombre => fetch(`/partido/${nombre}`, { method: 'DELETE' })))
      .then(() => location.reload())
      .catch(console.error);
  });
</script>
{% endblock %}
